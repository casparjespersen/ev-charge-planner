<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Production Forecast</title>
    <!-- Include Bootstrap 5 CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
        }
        .form-label {
            font-weight: bold;
        }
        .form-container {
            max-width: 500px;
            margin: auto;
        }
    </style>
</head>
<body>

<div class="container form-container">
    <h2 class="mb-4">Solar Production Forecast</h2>
    <div id="chart-container">
        <canvas id="forecastChart"></canvas>
    </div>
</div>

<!-- Include jQuery and Bootstrap 5 JS from CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Add Chart.js before your custom script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Constants from the trained model
    const MODEL_COEFFICIENTS = {
        'global_tilted_irradiance': 0.003844,
    };

    async function fetchForecast() {
        try {
            // Use Open-Meteo API directly
            const LATITUDE = 55.79;
            const LONGITUDE = 12.53;
            
            // Calculate date range for next 7 days
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(today.getDate() + 7);
            
            const url = new URL('https://api.open-meteo.com/v1/forecast');
            url.searchParams.append('latitude', LATITUDE);
            url.searchParams.append('longitude', LONGITUDE);
            url.searchParams.append('start_date', today.toISOString().split('T')[0]);
            url.searchParams.append('end_date', endDate.toISOString().split('T')[0]);
            url.searchParams.append('hourly', [
                'temperature_2m',
                'global_tilted_irradiance',
            ].join(','));
            url.searchParams.append('timezone', 'Europe/Copenhagen');
            url.searchParams.append('tilt', 26);
            url.searchParams.append('azimuth', 45);

            const response = await fetch(url);
            const data = await response.json();
            
            // Process hourly data
            const predictions = data.hourly.time.map((timestamp, index) => {
                // Normalize features as in the notebook
                const normalizedFeatures = {
                    global_tilted_irradiance: data.hourly.global_tilted_irradiance[index],
                };

                // Apply linear regression
                let prediction = 0;
                for (const [feature, coefficient] of Object.entries(MODEL_COEFFICIENTS)) {
                    prediction += normalizedFeatures[feature] * coefficient;
                }

                return {
                    timestamp: new Date(timestamp),
                    prediction: prediction
                };
            });

            // Group by day and sum predictions
            const dailyPredictions = predictions.reduce((acc, curr) => {
                const date = curr.timestamp.toISOString().split('T')[0];
                acc[date] = (acc[date] || 0) + curr.prediction;
                return acc;
            }, {});

            // Update chart
            updateChart(dailyPredictions);
        } catch (error) {
            console.error('Error fetching forecast:', error);
        }
    }

    function updateChart(dailyPredictions) {
        const ctx = document.getElementById('forecastChart').getContext('2d');
        
        // Format dates to be more readable
        const formattedLabels = Object.keys(dailyPredictions).map(date => {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
        });
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: 'Predicted Daily Production (kWh)',
                    data: Object.values(dailyPredictions).map(v => Number(v.toFixed(1))),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',  // This makes the chart horizontal
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Production (kWh)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.x.toFixed(1)} kWh`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Initial load
    fetchForecast();
</script>
</body>
</html>
